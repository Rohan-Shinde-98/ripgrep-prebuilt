parameters:
  target: ''
  gcc_version: ''
  rust_version: 'stable'
  repo: 'BurntSushi/ripgrep'
  tag: '12.1.1'

steps:
- script: |
    set -ex
    git clone https://github.com/${{ parameters.repo }}.git
    cd ripgrep
    git checkout ${{ parameters.tag }}
  displayName: Clone Ripgrep
- script: build/install.sh
  displayName: Install Rust
  env:
    RUST_VERSION: ${{ parameters.rust_version }}
    TARGET: ${{ parameters.target }}
    GCC_VERSION: ${{ parameters.gcc_version }}
- script: |
    sudo xcode-select -s /Applications/Xcode_12.2.app
  displayName: Switch to Xcode 12
  condition: eq('${{parameters.target}}', 'aarch64-apple-darwin')
- script: ../build/build.sh
  displayName: Build
  workingDirectory: ripgrep
  env:
    TARGET: ${{ parameters.target }}
- script: ../build/package.sh
  displayName: Package
  workingDirectory: ripgrep
  env:
    TARGET: ${{ parameters.target }}
    OUT_DIR: $(Build.ArtifactStagingDirectory)
  condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/v'))
- task: PublishPipelineArtifact@0
  displayName: 'Publish Pipeline Artifact'
  inputs:
    artifactName: $(Name)
    targetPath: $(Build.ArtifactStagingDirectory)/$(Name)
  condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/v'))